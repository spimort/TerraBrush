<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>TerraBrush C# TSCN Script Cleaner</title>
        <style>
            html,
            body {
                width: 100%;
                height: 100%;
                margin: 0;
                overflow: hidden;
                background: linear-gradient(173deg, #090725, #0b244b);
                color: white;
                font-family: Tahoma;
            }

            body {
                display: flex;
                flex-direction: column;
                padding: 20px;
                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                box-sizing: border-box;
                gap: 10px;
            }

            .container {
                display: flex;
                flex: 1 1 auto;
                gap: 10px;
            }

            .half {
                display: flex;
                flex: 1 1 auto;
                flex-direction: column;
                gap: 10px;
            }

            textarea {
                width: 100%;
                flex: 1 1 auto;
                resize: none;
                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                box-sizing: border-box;
                border-radius: 5px;
                padding: 10px;
                outline: none;
            }

            h1,
            p {
                margin: 0;
            }

            button {
                height: 40px;
                background: #4b914b;
                color: white;
                border-radius: 5px;
                border: 0;
                cursor: pointer;
            }
        </style>
    </head>

    <body>
        <h1>TerraBrush .tscn C# Script Cleaner</h1>
        <p>This helps you migrate from TerraBrush C# version to TerraBrush GDExtension. This script cleans references to the old .cs files.</p>
        <div class="container">
            <div class="half">
                <label for="input">Original .tscn:</label>
                <textarea id="input" placeholder="Paste your .tscn content here..."></textarea>
            </div>
            <div class="half">
                <label for="output">Cleaned .tscn:</label>
                <textarea id="output" placeholder="Output will appear here..." readonly></textarea>
            </div>
        </div>
        <button onclick="cleanTscn()">Clean TSCN</button>

        <script>
            function cleanTscn() {
                const input = document.getElementById('input').value;
                let lines = input.split('\n');

                const scriptTypesMatching = {
                    'TerraBrush.cs': 'TerraBrush',
                    'TextureSetResource.cs': 'TextureSetResource',
                    'TextureSetsResource.cs': 'TextureSetsResource',
                    'FoliageDefinitionResource.cs': 'FoliageDefinitionResource',
                    'FoliageResource.cs': 'FoliageResource',
                    'SnowResource.cs': 'SnowResource',
                    'WaterResource.cs': 'WaterResource',
                    'ObjectDefinitionResource.cs': 'ObjectDefinitionResource',
                    'ObjectResource.cs': 'ObjectResource',
                    'ObjectOctreeLODDefinitionResource.cs': 'ObjectOctreeLODDefinitionResource',
                    'ObjectOctreeLODMeshDefinitionResource.cs': 'ObjectOctreeLODMeshDefinitionResource',
                    'ObjectOctreeLODMeshesDefinitionResource.cs': 'ObjectOctreeLODMeshesDefinitionResource',
                    'MetaInfoLayer.cs': 'MetaInfoLayerResource',
                    'ZonesResource.cs': 'ZonesResource',
                    'ZoneResource.cs': 'ZoneResource',
                };

                const foundScripts = {};
                const extResourceRegex = /^\[ext_resource\s+type="Script".*path="([^"]+\.cs)".*id="([^"]+)"(?:.*uid="([^"]+)")?/;

                lines = lines.filter(line => {
                    const match = line.match(extResourceRegex);
                    if (match) {
                        const fullFileName = match[1];
                        const fileName = fullFileName.replace(/^.*[\\/]/, '');
                        const resourceType = scriptTypesMatching[fileName];
                        if (scriptTypesMatching[fileName]) {
                            const id = match[2];

                            foundScripts[id] = {
                                type: resourceType
                            };
                            return false;
                        }
                    }
                    return true;
                });

                Object.keys(foundScripts).forEach(id => {
                    const typeInfo = foundScripts[id];

                    const lineIndexes = lines.reduce((acc, line, index) => {
                        if (line.includes(`ExtResource("${id}")`)) {
                            acc.push(index);
                        }

                        return acc;
                    }, []);

                    lineIndexes.forEach(lineIndex => {
                        const nodeLine = lines[lineIndex - 1];
                        lines[lineIndex - 1] = nodeLine.replace(/type="[^"]*"/, `type="${typeInfo.type}"`);

                        for (let i = lineIndex + 1; i < lines.length; i++) {
                            const propertyLine = lines[i];
                            if (propertyLine === '') {
                                break;
                            }

                            if (propertyLine.startsWith('LOD')) {
                                lines[i] = `${propertyLine.substring(0, 3).toLowerCase()}${propertyLine.substring(3, propertyLine.length)}`;
                            } else {
                                lines[i] = `${propertyLine.substring(0, 1).toLowerCase()}${propertyLine.substring(1, propertyLine.length)}`;
                            }

                            if (typeInfo.type === 'ZoneResource') {
                                lines[i] = lines[i].replace('Texture', 'Image');
                            }
                        }
                    });

                    lines = lines.filter(line => {
                        return !line.includes(`ExtResource("${id}")`);
                    });
                });

                document.getElementById('output').value = lines.join('\n');
            }
        </script>
    </body>
</html>